name: Sync src from A_repo to B_repo

on:
  workflow_dispatch:
  push:

permissions:
  contents: write
  actions: write

jobs:
  push-src-to-b-repo:
    runs-on: ubuntu-latest

    env:
      TARGET_REPO: MURAO1120/B_repo
      FEATURE_BRANCH: feature/signal-ci
      WORKDIR: ${{ github.workspace }}/b-repo

    steps:
      # A_repo をチェックアウト
      - name: Checkout A_repo
        uses: actions/checkout@v4

      # Git 設定
      - name: Configure git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@users.noreply.github.com"

      # B_repo をクローンして main をチェックアウト
      - name: Clone B_repo
        run: |
          git clone https://github.com/${{ env.TARGET_REPO }} $WORKDIR
          cd $WORKDIR
          git fetch origin main
          git checkout main

      # feature ブランチを作成 or リセット
      - name: Prepare feature branch
        run: |
          cd $WORKDIR
          if git rev-parse --verify $FEATURE_BRANCH >/dev/null 2>&1; then
            git checkout $FEATURE_BRANCH
            git reset --hard main
          else
            git checkout -b $FEATURE_BRANCH
          fi

      # コピー前にデバッグ：コピー元とコピー先の確認
      - name: Debug before copy
        run: |
          echo "A_repo/src content:"
          ls -la ${{ github.workspace }}/src
          echo "B_repo/src content before deletion:"
          ls -la $WORKDIR/src || echo "Directory does not exist"

      # コピー先ディレクトリの中身を削除
      - name: Clear B_repo/src
        run: |
          mkdir -p $WORKDIR/src
          rm -rf $WORKDIR/src/* $WORKDIR/src/.[!.]* || true
          echo "B_repo/src after deletion (should be empty):"
          ls -la $WORKDIR/src

      # コピー後にデバッグ：コピーが成功したか確認
      - name: Copy src from A_repo to B_repo
        run: |
          cp -r ${{ github.workspace }}/src/* $WORKDIR/src/
          echo "B_repo/src after copy:"
          ls -la $WORKDIR/src

      # 変更をコミットして push
      - name: Commit and push changes
        run: |
          cd $WORKDIR
          git add src/*
          git commit -m "Sync src from A_repo" || echo "No changes to commit"
          git push https://x-access-token:${{ secrets.GENERAL_TOKEN_FOR_ACTIONS }}@github.com/${{ env.TARGET_REPO }} $FEATURE_BRANCH --force
